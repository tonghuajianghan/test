var Main_Tab	= null;
var cur_row	= null;
var cur_col	= null;
var act_bgc	= "#6985DE"; //定义鼠标滑动的背景颜色
var act_fc	= "white";// 定义鼠标滑过后字体的颜色
var cur_bgc	= "#A11CFF";//定义选中后的行颜色

function init(){
	cur_row			= null;
	cur_col			= null;
	cur_cell		= null;
	Main_Tab 		= PowerTable;
	read_def(Main_Tab);
	Main_Tab.onmouseover	= overIt;
	Main_Tab.onmouseout	= outIt;
	Main_Tab.onclick	= clickIt;
}

document.onselectstart	= function(){return false;};

document.onmouseup	= drag_end;

function clear_color(){
	the_table=Main_Tab;
	if(cur_col!=null){
		for(i=0;i<the_table.rows.length;i++){
			with(the_table.rows[i].cells[cur_col]){
				style.backgroundColor=oBgc;
				style.color=oFc;
			}
		}
	}
	if(cur_row!=null){
		for(i=0;i<the_table.rows[cur_row].cells.length;i++){
			with(the_table.rows[cur_row].cells[i]){
				style.backgroundColor=oBgc;
				style.color=oFc;
			}
		}
	}
	if(cur_cell!=null){
		cur_cell.children[0].contentEditable = false;
		with(cur_cell.children[0].runtimeStyle){
			borderLeft=borderTop="";
			borderRight=borderBottom="";
			backgroundColor="";
			paddingLeft="";
			textAlign="";
		}
	}
}

function document.onclick(){
	window.status = "";
	clear_color();
	cur_row  = null;
	cur_col  = null;
	cur_cell = null;
}

function read_def(the_table){
	for(var i=0;i<the_table.rows.length;i++){
		for(var j=0;j<the_table.rows[i].cells.length;j++){
			with(the_table.rows[i]){
				cells[j].oBgc = cells[j].currentStyle.backgroundColor;
				cells[j].oFc  = cells[j].currentStyle.color;
				if(i==0){
					cells[j].onmousedown = drag_start;
					cells[j].onmouseup = drag_end;
				}
			}
		}
	}
}

function get_Element(the_ele,the_tag){
	the_tag = the_tag.toLowerCase();
	if(the_ele.tagName.toLowerCase()==the_tag)return the_ele;
	while(the_ele=the_ele.offsetParent){
		if(the_ele.tagName.toLowerCase()==the_tag)return the_ele;
	}
	return(null);
}

var dragStart		= false;
var dragColStart	= null;
var dragColEnd		= null;

function drag_start(){
	var the_td	= get_Element(event.srcElement,"td");
	if(the_td==null)
		return;
	if(the_td.cellIndex==0)  //禁止nbbh移动
		return;
	dragStart	= true;
	dragColStart	= the_td.cellIndex;
	drag.style.width	= the_td.offsetWidth;
	drag.style.height	= the_td.offsetHeight;
	
	function document.onmousemove(){
		if(the_td.cellIndex==0) //禁止nbbh移动
			return;
		drag.style.display	= "";
		drag.style.top		= event.y - drag.offsetHeight/2;
		drag.style.left		= event.x - drag.offsetWidth/2;
		for(var i=0;i<Main_Tab.rows[0].cells.length;i++){
			with(Main_Tab.rows[0].cells[i]){
				if(cellIndex==0)
					continue;    //禁止nbbh移动
				if((event.y>offsetTop+parseInt(document.getElementById("projects").offsetTop)
				&& event.y<offsetTop+offsetHeight+parseInt(document.getElementById("projects").offsetTop))
				&& (event.x+document.getElementById("projects").scrollLeft>offsetLeft+parseInt(document.getElementById("projects").offsetLeft)
				&& event.x+document.getElementById("projects").scrollLeft<offsetLeft+offsetWidth+parseInt(document.getElementById("projects").offsetLeft))){
					runtimeStyle.backgroundColor = act_bgc;
					runtimeStyle.color=act_fc;
					runtimeStyle.backgroundImage = "url()";
					dragColEnd = cellIndex;
				}else{
					runtimeStyle.backgroundColor="";
					runtimeStyle.backgroundImage = "url(img/thead.gif)";
				}
			}
		}
		if(!(event.y>Main_Tab.rows[0].offsetTop+parseInt(document.getElementById("projects").offsetTop) && event.y<Main_Tab.rows[0].offsetTop+Main_Tab.rows[0].offsetHeight+parseInt(document.getElementById("projects").offsetTop)))
			dragColEnd = null;
	}
	drag.innerHTML = the_td.innerHTML;
	drag.style.backgroundColor = the_td.oBgc;
	drag.style.color = the_td.oFc;
}

function drag_end(){
	dragStart = false;
	drag.style.display="none";
	drag.innerHTML = "";
	drag.style.width = 0;
	drag.style.height = 0;
	for(var i=0;i<Main_Tab.rows[0].cells.length;i++){
		Main_Tab.rows[0].cells[i].runtimeStyle.backgroundColor="";
		Main_Tab.rows[0].cells[i].runtimeStyle.backgroundImage = "url(img/thead.gif)";
	}
	if(dragColStart!=null && dragColEnd!=null && dragColStart!=dragColEnd){
		change_col(Main_Tab,dragColStart,dragColEnd);
		document.onclick();
	}
	dragColStart = null;
	dragColEnd = null;
	document.onmousemove=null;
}

function clickIt(){
	event.cancelBubble=true;
	var the_obj = event.srcElement;
	var i = 0 ,j = 0;
	if(cur_cell!=null && cur_row!=0){
		cur_cell.children[0].contentEditable = false;
		with(cur_cell.children[0].runtimeStyle){
			borderLeft=borderTop="";
			borderRight=borderBottom="";
			backgroundColor="";
			paddingLeft="";
			textAlign="";
		}
	}
	if(the_obj.tagName.toLowerCase() != "table" && the_obj.tagName.toLowerCase() != "tbody" && the_obj.tagName.toLowerCase() != "tr"){
		var the_td	= get_Element(the_obj,"td");
		if(the_td==null) return;
		var the_tr	= the_td.parentElement;
		var the_table	= get_Element(the_td,"table");
		var i 		= 0;
		clear_color();
		cur_row = the_tr.rowIndex;
		cur_col = the_td.cellIndex;
		if(cur_row!=0){
			for(i=0;i<the_tr.cells.length;i++){
				with(the_tr.cells[i]){
					style.backgroundColor=cur_bgc;//选中后的行色
					style.color=act_fc; //选中后的字体颜色
				}
			}
		}
	}
}

function overIt(){
	if(dragStart)return;
	var the_obj = event.srcElement;
	var i = 0;
	if(the_obj.tagName.toLowerCase() != "table"){
		var the_td	= get_Element(the_obj,"td");
		if(the_td==null) return;
		var the_tr	= the_td.parentElement;
		var the_table	= get_Element(the_td,"table");
		if(the_tr.rowIndex!=0){
			for(i=0;i<the_tr.cells.length;i++){
				with(the_tr.cells[i]){
					runtimeStyle.backgroundColor=act_bgc;
					runtimeStyle.color=act_fc;
				}
			}
		}else{
			for(i=1;i<the_table.rows.length;i++){
				with(the_table.rows[i].cells(the_td.cellIndex)){
					runtimeStyle.backgroundColor=act_bgc;
					runtimeStyle.color=act_fc;
				}
			}
			if(the_td.cellIndex!=0)      //禁止nbbh移动
				the_td.style.cursor = "move";
		}
	}
}

function outIt(){
	var the_obj = event.srcElement;
	var i=0;
	if(the_obj.tagName.toLowerCase() != "table"){
		var the_td	= get_Element(the_obj,"td");
		if(the_td==null) return;
		var the_tr	= the_td.parentElement;
		var the_table	= get_Element(the_td,"table");
		if(the_tr.rowIndex!=0){
			for(i=0;i<the_tr.cells.length;i++){
				with(the_tr.cells[i]){
					runtimeStyle.backgroundColor='';
					runtimeStyle.color='';				
				}
			}
		}else{
			var the_table=the_tr.parentElement.parentElement;
			for(i=0;i<the_table.rows.length;i++){
				with(the_table.rows[i].cells(the_td.cellIndex)){
					runtimeStyle.backgroundColor='';
					runtimeStyle.color='';
				}
			}
		}
	}
}

function change_col(the_tab,line1,line2){
	for(var i=0;i<the_tab.rows.length;i++)
		the_tab.rows[i].cells[line1].swapNode(the_tab.rows[i].cells[line2]);
}

function encodePagiUrl(a){
	var tempUrl = encodeURI(encodeURI(a.href));
	a.href = tempUrl;
	return true;
}

function setCols(id){
	document.getElementById("cover").style.display="block";
	document.getElementById(id).style.display="block";
}
function hide(id){
	document.getElementById("cover").style.display="none";
	document.getElementById(id).style.display="none";
}
function clickLi(obj){
	if(event.srcElement.tagName!="LI")
		return;
	obj.firstChild.checked=!obj.firstChild.checked;
}
var isAll = false;
function checkAll(){
	if(isAll)
		isAll = false;
	else
		isAll = true;
	var chs = document.ShowCon.sfield;
	for(var i=0;i<chs.length;i++){
		chs[i].checked = isAll;
	}
}
function buildTable(){
	var tableHead = document.getElementById("TableHead");
	var lis = document.getElementsByTagName("li");
	var size = lis.length;
	var n = 0;
	var num = new Array();
	for(var i=0;i<size;i++){
		if(!lis[i].firstChild.checked)
			continue;
		var newTD = tableHead.insertCell(n);
		newTD.setAttribute("noWrap","true");
		newTD.innerHTML = lis[i].innerText;
		num[n] = i;
		n++;
	}
	
	//修改数组以便显示空格
	for(var i = 0; i < contents.length; i++){
		var str = contents[i];
		if(str.length == 0){
			contents[i] = '&nbsp;';
		}
	}
	
	var table = document.getElementById("PowerTable");
	for(var i=0;i<pSize;i++){
		var newTR = table.insertRow(i+1);
		newTR.setAttribute("bgColor", i%2==0?"#FFFFFF":"#BAC9E0"); //修改powertable的背景颜色修改奇偶列的样式
		for(var j=0;j<n;j++){
			var newTD = newTR.insertCell(j);
			newTD.setAttribute("noWrap","true");
			newTD.innerHTML = contents[num[j] + allSize*i];
		}
	}
}
function removeTable(){
	var div = document.getElementById("projects");
	div.innerHTML = "<table id='PowerTable' class='projects' border='1' cellpadding='0' cellspacing='0'>"+
						"<tr id='TableHead' style='font-weight: bold;'></tr>"+
					"</table>";
}
function reBuildTable(predix){
	var chs = document.ShowCon.sfield;
	chs[0].checked = true; //选择主键
	var isChecked = false;
	for(var i=0;i<chs.length;i++)
		if(chs[i].checked){
			isChecked = true;
			break;
		}
	if(!isChecked){
		alert("请至少选择一个字段！");
		return;
	}
	if(document.ShowCon.save.checked)
		if(confirm('您确定要保存本次设置吗？该操作将会影响所有用户！')){
			document.ShowCon.action = document.ShowCon.action + "&predix=" + predix;
			document.ShowCon.submit();
			return;
		}else
			alert("您取消了保存设置！");
	removeTable();
	buildTable();
	init();
	hide('control');
}