//鏈枃浠舵棤闇�慨鏀�
//濡傞渶淇敼锛屾帹鑽愬彧淇敼鏈枃浠朵腑鐨勬牱寮忓睘鎬э紙.style灞炴�锛夊拰Ajax璇锋眰鐨勯摼鎺ワ紙鍦ㄦ渶鍚庯級
//1. ac_jsonresult_to_html()鐨勬敞閲婄敤浜庝慨鏀瑰～鍏呯殑鏁伴噺锛屽彲淇敼
//2. 浣跨敤鏃跺厛鍒濆鍖朼c_set_areaid()锛屽彲淇敼   绗竴涓細瑙﹀彂鍖哄煙锛岀浜屼釜锛氭樉绀哄尯鍩燂紝绗笁涓細闅愯棌鏁版嵁鍩�
//3. 淇敼xmlHttp涓殑璇锋眰

//================绯荤粺鏁版嵁锛屼笉瑕佷慨鏀�==================
//璁板綍杩斿洖鐨則able鐨勮鏁�
var ac_tableTotalRow = 0;
//璁板綍褰撳墠婊氬姩鍒扮殑琛屾暟
var ac_curTableTotalRow = -2;
//瀛樺偍鏇存敼鍓嶇殑鏂囨湰妗嗙殑鍊硷紝闃叉閲嶅鎻愪氦
var ac_previousContent = "";
//json鏁版嵁
var ac_json_data;

//闅愯棌鍖哄煙濉�锛岄殣钘忓尯鍩烮D涓猴細
var ac_hidden_area = "";
//瑙﹀彂鍖哄煙ID锛�
var ac_trigger_area = "";
//鍒楄〃鍖哄煙ID锛�
var ac_list_area = "";
//鏄惁濉厖闄ら殣钘忓尯鍩熷鍏朵粬鍖哄煙
var ac_fill_other = false;

//鏄惁鑷畾涔夊～鍐欏叾浠栧尯鍩�
var ac_custom_fill = false;
//鑷畾涔夌殑鍏朵粬鍖哄煙濉啓鏂规硶
var ac_custom_fill_func;
//鑷畾涔夌殑鍏朵粬鍖哄煙娓呴櫎鏂规硶
var ac_custom_unfill_func;
//================绯荤粺鏁版嵁锛屼笉瑕佷慨鏀�==================



/**
 * 璁剧疆涓尯鍩焛d  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!onload鍒濆鍖�  蹇呴』璋冪敤
 * @param triggerid瑙﹀彂鍩�
 * @param listid鍒楄〃鍩�
 * @param hiddenid闅愯棌鍩�
 * @param fillother鏄惁濉啓鍏朵粬鍖哄煙
 * @param fill_func濉啓鍏朵粬鍖哄煙鐨勬柟娉曪紝鍙傛暟涓轰竴涓瓧绗︿覆鏁扮粍锛屽惈涔変负锛氭�鍒� 鍑虹敓鏃ユ湡, 瀛﹀巻, 鑱岀О, 瀛︿綅, 鎵�湪鍗曚綅, 韬唤璇佸彿, 宸ヨ祫浠ｅ彿
 * @param unfill_func娓呴櫎鍏朵粬鍖哄煙鐨勬柟娉曪紝鏃犲弬鏁�
 */
function ac_set_areaid(triggerid, listid, hiddenid, fillother, fill_func, unfill_func)
{
	ac_hidden_area = hiddenid;
	ac_trigger_area = triggerid;
	ac_list_area = listid;
	ac_fill_other = fillother;
	if(fill_func == undefined || unfill_func == undefined)
		return;
	ac_custom_fill = true;
	ac_custom_fill_func = fill_func;
	ac_custom_unfill_func = unfill_func;
}

/**
 * 榧犳爣绉诲姩鍒皌d涓婄殑鍙樺寲
 */
function ac_overState(eTd)
{
	for(var i = 0; i < eTd.parentNode.parentNode.childNodes.length; i++){
		eTd.parentNode.parentNode.childNodes[i].style.color = "black";
		eTd.parentNode.parentNode.childNodes[i].style.backgroundColor = "white";
	}
	eTd.parentNode.style.color = "#333333";
	eTd.parentNode.style.backgroundColor = "#E2EAFF";
}

/**
 * 榧犳爣鑴辩td鐨勫彉鍖�
 */
function ac_outState(eTd)
{
	eTd.parentNode.style.color = "black";
	eTd.parentNode.style.backgroundColor = "white";
}

/**
 * 榧犳爣鐐瑰嚮鏃跺～鍏�
 */
function ac_textFill(eTd)
{
	document.getElementById(ac_trigger_area).value = eTd.parentNode.childNodes[0].firstChild.firstChild.nodeValue;
	ac_util_clicknum(eTd.parentNode.childNodes[0].getAttribute('name'));
	//浣跨敤褰撳墠搴忓彿鐨勬暟鎹洿鏀规枃鏈�
	ac_content_fill(ac_curTableTotalRow);
	document.getElementById(ac_list_area).style.display = "none";
	ac_previousContent = eTd.parentNode.childNodes[0].firstChild.firstChild.nodeValue;
	//娉ㄩ攢榧犳爣鏃堕棿鎹曡幏
	document.onmouseup=null;
	//娉ㄩ攢鎸夐敭浜嬩欢鎹曡幏
	document.onkeydown = null;
}

/**
 * 杈撳叆涓�釜璇嶆椂璋冪敤鐨勬柟娉�
 * 鎺у埗ID涓篴cBox鐨刣iv
 */
function ac_getAutoComplete(eInput)
{
	//鍒楄〃鍖虹姝㈤�鎷�
	document.getElementById(ac_list_area).onselectstart = function(event){return false;};
	if(eInput.value.length == 0){
		document.getElementById(ac_list_area).style.display = "none";
		//娉ㄩ攢榧犳爣鏃堕棿鎹曡幏
		document.onmouseup=null;
		//娉ㄩ攢鎸夐敭浜嬩欢鎹曡幏
		document.onkeydown = null;
		//娓呯┖鍘熷唴瀹�
		ac_previousContent = "";
		return;
	}
	if(ac_previousContent.length == eInput.value.length && eInput.value == ac_previousContent){
		return;
	}
	//娓呯┖鑷姩濉啓鍖哄煙
	ac_clear_fillArea();
	ac_previousContent = eInput.value;
	var xmlHttp;
	try {
		// Firefox, Opera 8.0+, Safari
		xmlHttp = new XMLHttpRequest();
	} catch (e) {
		// Internet Explorer
		try {
			xmlHttp = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (e) {
			try {
				xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
			} catch (e) {
				alert("鎮ㄧ殑娴忚鍣ㄤ笉鏀寔AJAX锛�");
				return;
			}
		}
	}
	xmlHttp.onreadystatechange = function() {
		if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
			//娉ㄩ攢榧犳爣鏃堕棿鎹曡幏
			document.onmouseup=null;
			//娉ㄩ攢鎸夐敭浜嬩欢鎹曡幏
			document.onkeydown = null;
			document.getElementById(ac_list_area).style.display = "inline-block";
			document.getElementById(ac_list_area).innerHTML = ac_jsonresult_to_html(xmlHttp.responseText);
			if(document.getElementById("ac_completeBox") == null)
				return;
			tableTotalColumn = document.getElementById("ac_completeBox").childNodes[0].childNodes.length;
			ac_curTableTotalRow = -2;
			//璁剧疆榧犳爣鎸変笅浜嬩欢锛屽叧闂笅鎷夋
			document.onmouseup=function() {
				var ev = event || window.event;
				if (!ev) {
					var c = this.getEvent.caller;
					while (c) {
						ev = c.arguments[0];
						if (ev && (Event == ev.constructor || MouseEvent  == ev.constructor)) {
							break;
						}
						c = c.caller; 
					} 
				}
				//浠ヤ笂鑾峰彇浜嬩欢ev
				//浠ヤ笅鍏抽棴涓嬫媺妗�
				var isOnTD = (ev.srcElement.tagName.length == "td".length
								&& ev.srcElement.tagName.toLowerCase().indexOf("td") == 0);
				//鍒ゆ柇鏄惁鏄湪涓嬫媺妗嗘墍鍦ㄧ殑div鎴杢able鐨勮竟妗嗕笂鐐瑰嚮鐨勶紝鎴栭噸澶嶇偣鍑昏緭鍏ユ
				var isOnDivOrTableOrInput = ev.srcElement.getAttribute("id")!=null
											&&	((ev.srcElement.getAttribute("id").length == ac_list_area.length
													&& ev.srcElement.getAttribute("id").indexOf(ac_list_area) == 0)
												|| (ev.srcElement.getAttribute("id").length == "ac_completeBox".length
													&& ev.srcElement.getAttribute("id").indexOf("ac_completeBox") == 0)
												|| (ev.srcElement.getAttribute("id").length == ac_trigger_area.length
													&& ev.srcElement.getAttribute("id").indexOf(ac_trigger_area) == 0)
												);
				if(!isOnTD){
					if(isOnDivOrTableOrInput)
						return;
					document.getElementById(ac_list_area).style.display = "none";
				}
				ac_previousContent = "";
				//娉ㄩ攢榧犳爣鏃堕棿鎹曡幏
				document.onmouseup=null;
				//娉ㄩ攢鎸夐敭浜嬩欢鎹曡幏
				document.onkeydown = null;
				//鎺у埗濡傛灉鐐瑰埌鍏朵粬table鐨則d搴旇鍏抽棴涓媋鎷夋
				if(isOnTD
					&& (!ev.srcElement.parentNode.parentNode.parentNode.getAttribute("id").length == "ac_completeBox".length
					|| !ev.srcElement.parentNode.parentNode.parentNode.getAttribute("id").indexOf("ac_completeBox") == 0) )
					document.getElementById(ac_list_area).style.display = "none";
				//濡傛灉闅愯棌鍖烘湁锛屽垯涓嶅垹闄ゆ墍濉�
				if(document.getElementById(ac_hidden_area).value == null || document.getElementById(ac_hidden_area).value.length == 0)
					document.getElementById(ac_trigger_area).value = "";
			};
			//璁剧疆鏂瑰悜閿笂涓嬬殑浜嬩欢
			document.onkeydown=function(){
				//38涓� 40涓�
				switch(event.keyCode){
				case 38:
					if(document.getElementById("ac_completeBox").childNodes[0].childNodes[ac_curTableTotalRow] != null){
						ac_outState(document.getElementById("ac_completeBox").childNodes[0].childNodes[ac_curTableTotalRow]);
					}
					ac_curTableTotalRow--;
					if(ac_curTableTotalRow < 0 || ac_curTableTotalRow >= tableTotalColumn)
						ac_curTableTotalRow = tableTotalColumn - 1;
					ac_overState(document.getElementById("ac_completeBox").childNodes[0].childNodes[ac_curTableTotalRow].firstChild);
					document.getElementById(ac_trigger_area).value = document.getElementById("ac_completeBox").childNodes[0].childNodes[ac_curTableTotalRow].firstChild.firstChild.firstChild.nodeValue;
					//浣跨敤褰撳墠搴忓彿鐨勬暟鎹洿鏀规枃鏈�
					ac_content_fill(ac_curTableTotalRow);
					ac_previousContent = document.getElementById(ac_trigger_area).value;
					break;
				case 40:
					if(document.getElementById("ac_completeBox").childNodes[0].childNodes[ac_curTableTotalRow] != null){
						ac_outState(document.getElementById("ac_completeBox").childNodes[0].childNodes[ac_curTableTotalRow]);
					}
					ac_curTableTotalRow++;
					if(ac_curTableTotalRow < 0 || ac_curTableTotalRow >= tableTotalColumn)
						ac_curTableTotalRow = 0;
					ac_overState(document.getElementById("ac_completeBox").childNodes[0].childNodes[ac_curTableTotalRow].firstChild);
					document.getElementById(ac_trigger_area).value = document.getElementById("ac_completeBox").childNodes[0].childNodes[ac_curTableTotalRow].firstChild.firstChild.firstChild.nodeValue;
					//浣跨敤褰撳墠搴忓彿鐨勬暟鎹洿鏀规枃鏈�
					ac_content_fill(ac_curTableTotalRow);
					ac_previousContent = document.getElementById(ac_trigger_area).value;
					break;
				//鍥炶溅浜嬩欢
				//13澶ч敭鐩�   108灏忛敭鐩�
				case 13:
				case 108:
					ac_textFill(document.getElementById('ac_elem_num'+ac_curTableTotalRow));
					return false;
					break;
				}
			};
		}
	};
	//Ajax璇锋眰鐨勮繛鎺�
	xmlHttp.open("GET","mMember.action?method=getMembersAjax&mquery="+encodeURI(encodeURI(eInput.value)),true);
	xmlHttp.send(null);
}

/**
 * 灏咼SON瀛楃涓叉崲鎴怘TML  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 * 姝ら」鐨勭紪杈戯細
 * 1.json鏁版嵁鍦ㄦ湰鍑芥暟涓鍙栫殑娆℃暟
 * 2.鍚庡彴鐢熸垚鐨刯son鏁版嵁
 * 3.濉厖鍑芥暟鐨勫～鍏呮暟閲廰c_content_fill()
 * 4.娓呯┖闅愯棌鍖哄煙鏂囨湰ac_clear_fillArea()
 * 娉ㄦ剰锛氭渶涓昏鐨勬暟鎹负绗竴椤�td)
 *       闅愯棌鏁版嵁鏀惧湪绗竴椤逛箣鍚�
 */
function ac_jsonresult_to_html(jsonstr)
{
	ac_json_data = eval('('+jsonstr+')');
	if(ac_json_data[0].id===undefined)
		return "";
	var htmlFill = "<table id='ac_completeBox' style='background-color:white;'>";
	var i = 0;
	while(i < ac_json_data.length){
		htmlFill += "<tr>";
		htmlFill += "<td width='15%' id='ac_elem_num"+i+"' name='ac_elem_num"+i+"' width='30%' onmouseover='ac_overState(this)' onmouseout='ac_outState(this)' onmouseup='ac_textFill(this)'>";
		htmlFill += "<span>";
		htmlFill += ac_json_data[i].xm;
		htmlFill += "</span>";
		htmlFill += "</td>";
		//-----------鑷畾涔夋坊鍔�鎸夌収鏍煎紡-----------
		htmlFill += "<td width='30%' onmouseover='ac_overState(this)' onmouseout='ac_outState(this)' onmouseup='ac_textFill(this)'>";
		htmlFill += "<span>";
		htmlFill += ac_json_data[i].idcardno;
		htmlFill += "</span>";
		htmlFill += "</td>";
		htmlFill += "<td width='55%' onmouseover='ac_overState(this)' onmouseout='ac_outState(this)' onmouseup='ac_textFill(this)'>";
		htmlFill += "<span>";
		htmlFill += ac_json_data[i].szdw_val;
		htmlFill += "</span>";
		htmlFill += "</td>";
		//----------------------------------------
		htmlFill += "</tr>";
		i++;
	}
	htmlFill += "</table>";
	
	return htmlFill;
}
/**
 * 璁剧疆闅愯棌鍖哄煙鏂囨湰  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 * @param str
 */
function ac_content_fill(ac_curTableTotalRow)
{
	document.getElementById(ac_hidden_area).value = ac_json_data[ac_curTableTotalRow].id;
	if(!ac_fill_other)
		return;
	if(ac_custom_fill){
		var list = [];
		list[0] = ac_json_data[ac_curTableTotalRow].xb;
		list[1] = ac_json_data[ac_curTableTotalRow].csrq;
		list[2] = ac_json_data[ac_curTableTotalRow].xl_val;
		list[3] = ac_json_data[ac_curTableTotalRow].zc_val;
		list[4] = ac_json_data[ac_curTableTotalRow].xw;
		list[5] = ac_json_data[ac_curTableTotalRow].szdw_val;
		list[6] = ac_json_data[ac_curTableTotalRow].idcardno;
		list[7] = ac_json_data[ac_curTableTotalRow].paycode;
		ac_custom_fill_func(list);
		return;
	}
	if(ac_json_data[ac_curTableTotalRow].xb == '鐢�)
		document.getElementById("sexmale").checked = true;
	else if(ac_json_data[ac_curTableTotalRow].xb == '濂�)
		document.getElementById("sexfemale").checked = true;
	theForm.birth.value = ac_json_data[ac_curTableTotalRow].csrq;
	theForm.diploma.value = ac_json_data[ac_curTableTotalRow].xl_val;
	theForm.professionalTitle.value = ac_json_data[ac_curTableTotalRow].zc_val;
	theForm.degree.value = ac_json_data[ac_curTableTotalRow].xw;
	theForm.organization.value = ac_json_data[ac_curTableTotalRow].szdw_val;
	theForm.idCardNo.value = ac_json_data[ac_curTableTotalRow].idcardno;
	theForm.payCode.value = ac_json_data[ac_curTableTotalRow].paycode;
}
/**
 * 娓呯┖闅愯棌鍖哄煙鏂囨湰
 */
function ac_clear_fillArea()
{
	document.getElementById(ac_hidden_area).value = "";
	if(!ac_fill_other)
		return;
	if(ac_custom_fill){
		ac_custom_unfill_func();
		return;
	}
	document.getElementById("sexmale").checked = false;
	document.getElementById("sexfemale").checked = false;
	theForm.birth.value = "";
	theForm.diploma.value = "";
	theForm.professionalTitle.value = "";
	theForm.degree.value = "";
	theForm.organization.value = "";
	theForm.idCardNo.value = "";
	theForm.payCode.value = "";
}



//===============util==========
/**
 * 鐢ㄤ簬榧犳爣鐐瑰嚮鍚庣粺璁″叾鍦ㄥ垪琛ㄤ腑鐨勪綅缃�
 */
function ac_util_clicknum(tdname)
{
	var elems = document.getElementById("ac_completeBox").childNodes[0].childNodes;
	var i = 0;
	while(i < tableTotalColumn){
		if(elems[i++].firstChild.getAttribute('name')==tdname){
			ac_curTableTotalRow = i-1;
			return;
		}
	}
}